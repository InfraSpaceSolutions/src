@{
    Layout = "~/Shared/_Layout.cshtml";

    // create an unmanaged page
    Page.SitePage = new SiteWebPage();
    Page.SitePage.ApplyName("Update Billing Information");
    
    // make sure the user is logged in
    if ( !SiteAccount.IsLoggedIn() )
    {
        Response.Redirect(Href("~/AccountLogin"), false);
        return;
    }

    // this page needs SSL if it is available (we're in production)
    if (SSL.ForceSSL())
    {
        Layout = null;
        return;
    }
    
    SiteAccount siteAccount = new SiteAccount();
    
    // subscription support
    SiteSubscription siteSubscription = new SiteSubscription();
    if (siteSubscription.PtyID != (int)PaymentTypes.AuthNet)
    {
        Layout = null;
        Response.Redirect("~/Account/UpdateSubscriptionUnavailable", false);
        return;
    }


    WebDBContext db = new WebDBContext();
    
    //get the states for the state dropdownlist( only US states for now )
    var rsSta = db.TblStates.Where(target => target.CtrID == 186).OrderBy(target => target.StaName).ToList();

    // process postbacks of the form
    if (IsPost)
    {
        if (siteSubscription.UpdateBilling(Request.Form))
        {
            Response.Redirect(Href("~/Account/Dashboard/?Msg=Modify"), false);
            Layout = null;
            return;
        }
    }
    
}
@section head
{
	<script src="@Href( "~/Scripts/jquery.validate.min.js" )" type="text/javascript"></script>
	<script type="text/javascript">
	    $(document).ready(function () {
	        $("#frm").validate(
			{
			    messages:
				{
				    txtSubBillCardNumber: { required: "required" },
				    selSubBillExpMonth: { required: "required" },
				    selSubBillExpYear: { required: "required" },
                    txtSubBillCVV: { required: "required" },
				    txtSubBillFName: { required: "required" },
				    txtSubBillLName: { required: "required" },
				    txtSubBillAddress: { required: "required" },
				    txtSubBillCity: { required: "required" },
				    selSubBillState: { required: "required" },
				    txtSubBillZip: { required: "required" }
				}
			});
	    });
	</script>
}
	<!-- PAGE -->
	<div id="page">
        <!-- BREAD CRUMBS -->
        <div class="breadcrumbs Roles">
            <div class="breadcrumbGray"><a href="@Href( "~/Account/" )">Account Dashboard</a></div>
			<div class="breadcrumbEndGray">&nbsp;</div>
        </div>
		<div id="fullSide">
			<h1>@Html.Raw( Page.SitePage.Heading )</h1>
            @Html.Raw( Page.SitePage.Body )
            @if( siteSubscription.ResultCode != Sancsoft.Web.RC.Ok )
            {
                <div style="font-weight:bold;color:Red;">@siteSubscription.ResultTitle( )</div>
                <p style="color:Red;">@siteSubscription.ResultMessage( )</p>
            }
            <form id="frm" method="post" class="basicForm">
                <fieldset style="margin:0px auto;"><legend />
			        <div class="hrGray" style="margin-bottom:20px;">&nbsp;</div>
                    <br />
                    <div style="padding-right:20px;" class="CreditCardError">
                        <label for="txtSubBillCardNumber">Credit Card<img src="@Href( "~/images/creditcards.jpg" )" width="103" height="19" alt="" border="0" style="position:absolute; top:-4px; left:75px;" /></label>
                        <br />
                        <input type="text" name="txtSubBillCardNumber" class="required" maxlength="20" value="@siteSubscription.CardNumber" style="width:152px;" />
                    </div>
                    <div>
                        <label for="selSubBillExpMonth selSubBillExpYear">Expiration</label><br />
                        <select id="selSubBillExpMonth" name="selSubBillExpMonth" class="required">
                            <option value="">Month</option>
                            @for( int i=1; i <= 12; i++ )
                            {
                                <option value="@(i)" @((siteSubscription.SubBillExpMonth == i ) ? " selected" : "" )>@(i)</option>
                            }
                        </select>
                        <select id="selSubBillExpYear" name="selSubBillExpYear" class="required">
                            <option value="">Year</option>
                            @for( int i = 0; i <= 10; i++ )
                            {
                                <option value="@(DateTime.Today.Year + i )" @(( siteSubscription.SubBillExpYear == DateTime.Today.Year + i ) ? " selected" : "")>@(DateTime.Today.Year + i)</option>
                            }
                        </select>
                    </div>
                    <div>
                        <label for="txtSubBillCVV">CVV</label><br />
                        <input type="text" name="txtSubBillCVV" value="" class="required" style="width:74px;" />
                    </div>
                    <br style="clear:left;" />
                    <br />
                    <div>
                        <label for="txtSubBillFName">First Name</label><br />
                        <input type="text" name="txtSubBillFName" class="required" maxlength="50" value="@siteSubscription.SubBillFName"/>
                    </div>
                    <div>
                        <label for="txtSubBillLName">Last Name</label><br />
                        <input type="text" name="txtSubBillLName" class="required" maxlength="50" value="@siteSubscription.SubBillLName"/>
                    </div>
                    <br style="clear:left;" />
                    <br />
                    <div>
                        <label for="txtSubBillAddress">Billing Address</label><br />
                        <input type="text" name="txtSubBillAddress" class="required" maxlength="128" value="@siteSubscription.SubBillAddress" style="width:360px;" />
                    </div>
                    <br style="clear:left;" />
                    <br />
                    <div>
                        <label for="txtSubBillCity">City</label><br />
                        <input type="text" name="txtSubBillCity" class="required" maxlength="50" value="@siteSubscription.SubBillCity"/>
                    </div>
                    <div>
                        <label for="selSubBillState">State</label><br />
                        <select id="selSubBillState" name="selSubBillState" class="required">
                            <option value="">Select...</option>
                            @foreach( var sta in rsSta )
                            {
                                <option value="@(sta.StaAbbr)" @(( siteSubscription.SubBillState == sta.StaAbbr ) ? " selected" : "" )>@Html.Raw( sta.StaName )</option>
                            }
                        </select>
                    </div>
                    <br style="clear:left;" />
                    <br />
                    <div>
                        <label for="txtSubBillZip">Zip Code</label><br />
                        <input type="text" name="txtSubBillZip" class="required" maxlength="20" value="@siteSubscription.SubBillZip" style="width:130px;" />
                    </div>
                    <br style="clear:left;" />
                    <div class="orangeArrowButtonRight">
                        <input type="submit" name="_btnSubmit" value="Continue" class="button" />
                    </div>
        			<div class="orangeBackButtonRight" style="margin-left:30px;margin-top:10px;"><a href="@Href( "~/Account/Dashboard" )">BACK</a></div>
                    <br style="clear:both;" />
                </fieldset>
            </form>
		</div>
		<br style="clear:left;" />
	</div>