@{
    Layout = "~/Shared/_Layout.cshtml";

    // create an unmanaged page
    Page.SitePage = new SiteWebPage();
    Page.SitePage.ApplyName("Gallery Image Modify");
    
    // make sure the user is logged in
    if ( !SiteAccount.IsLoggedIn() )
    {
        Response.Redirect(Href("~/AccountLogin"), false);
        return;
    }

    WebDBContext db = new WebDBContext();

    SiteBusiness siteBusiness = new SiteBusiness();
    
    int galID = WebConvert.ToInt32(UrlData[0], 0);
    long imageTicks = DateTime.Now.Ticks;

    // Get validate the target
    TblGalleryItems rs = db.TblGalleryItems.SingleOrDefault( target => target.BusID == siteBusiness.BusID && target.GalID == galID );
    if ( rs == null )
    {
        throw new Sancsoft.Web.WebException( Sancsoft.Web.RC.TargetDNE );
    }
    
    if (IsPost)
    {
        bool fileError;
        ImageManager.CreateUpdateBusinessGalleryItem( Request.Files[0], siteBusiness.BusID, galID, out fileError );

        // redirect to the dashboard
        if (!fileError)
        {
            Response.Redirect(Href("~/Business/Dashboard?msg=Modify"), false);
            return;
        }
    }
}
@section head
{
	<script src="@Href( "~/Scripts/jquery.validate.min.js" )" type="text/javascript"></script>
	<script type="text/javascript">
	    $(document).ready(function () {
	        $("#frm").validate(
			{
			    messages:
				{
				    txtMenName: { required: "required" },
				    txtMenPrice: { required: "required" }
	            }
			});
	    });
	</script>
}
	<!-- PAGE -->
	<div id="page">
        <!-- BREAD CRUMBS -->
        <div class="breadcrumbs Roles">
            <div class="breadcrumbGray"><a href="@Href( "~/Account/" )">Account Dashboard</a></div>
			<div class="breadcrumbSpacerGrayGray">&nbsp;</div>
            <div class="breadcrumbGray"><a href="@Href( "~/Business/Dashboard" )">Business Dashboard</a></div>
			<div class="breadcrumbEndGray">&nbsp;</div>
        </div>
		<div id="fullSide">
			<h1>@HttpUtility.HtmlEncode(siteBusiness.BusName): @Html.Raw( Page.SitePage.Heading )</h1>
            @Html.Raw( Page.SitePage.Body )
            @if ( IsPost )
            {
                <div class="NotificationBox Red">
                    <div class="NotificationMessage">Something went wrong. Please try uploading the image again.</div>
                    <div class="NotificationClose"></div>
                </div>
                <br />
            }
            <!-- DASHBOARD -->
            <form name="frm" id="frm" method="post" class="basicForm" enctype="multipart/form-data">
                <fieldset style="width:770px;">
                    <div>
                        <label for="txtMenName">Image File: *</label><br />
                        <input type="file" name="fileUpload" id="fileUpload" class="required" style="width:350px; border-width:0; box-shadow:none;" />
                    </div>
                    <br style="clear:left;" />
                    <br />
                    <div style="float:none; margin-right:0px;">
                        <div class="orangeButtonRight">
                            <input type="submit" name="_btnSubmit" value="Upload" class="button" />
                        </div>
                        <div class="orangeButtonRight">
                            <input type="button" name="_btnCancel" value="Cancel" class="button" onclick="javascript: window.location = '/Business/Dashboard';" />
                        </div>
                    </div>
                    <legend></legend>
                </fieldset>
            </form>

            <br />
            <br />
            <div style="float: left; width: 45%; margin-right:5%;">
                <h3>Current Gallery Image</h3>
                <br />
                <img src="/BusinessGallery/@(rs.GalGuid).png?t=@(imageTicks)" style="width:100%; height:auto;" alt="Gallery Image" border="0" />
            </div>
            <div style="float: left;">
                <h3>Auto-Cropped Thumbnail</h3>
                <br />
                <img src="/BusinessGallery/@(rs.GalGuid).thumb.png?t=@(imageTicks)" alt="Gallery Thumbnail" border="0" />
            </div>
            <br style="clear:left;" />
            <br />
		</div>
		<br style="clear:left;" />
	</div>