@{
    Layout = "~/Shared/_Layout.cshtml";

    // create an unmanaged page
    Page.SitePage = new SiteWebPage();
    Page.SitePage.ApplyName("Recurring Event");
    
    // make sure the user is logged in
    if ( !SiteAccount.IsLoggedIn() )
    {
        Response.Redirect(Href("~/AccountLogin"), false);
        return;
    }

    // get the message from the query string ( form submission message )
    string msg = WebConvert.ToString(Request.QueryString["Msg"], "");
    
    int evjID = WebConvert.ToInt32(UrlData[0], 0);

    WebDBContext db = new WebDBContext();

    SiteBusiness siteBusiness = new SiteBusiness();

    SiteBusinessInfo siteBusinessInfo = new SiteBusinessInfo(siteBusiness.BusID);

    // get the event to edit / delete - make sure that it is associated with the active business
    SiteEventJob siteEventJob = new SiteEventJob(evjID);
    if (siteEventJob.BusID != siteBusiness.BusID)
    {
        throw new Sancsoft.Web.WebException(Sancsoft.Web.RC.AccessDenied);
    }

    // get the event types for the dropdown
    IEnumerable<TblEventTypes> rsEtt = db.TblEventTypes.OrderBy(target => target.EttID);

    // get the event job types for the dropdown
    IEnumerable<TblEventJobTypes> rsEjt = db.TblEventJobTypes.OrderBy(target => target.EjtID);

    if (IsPost)
    {
        siteEventJob.EttID = WebConvert.ToInt32(Request.Form["selEttID"], 0);
        siteEventJob.EjtID = WebConvert.ToInt32(Request.Form["selEjtID"], 0);
        switch (siteEventJob.EjtID)
        {
            case 1:
                siteEventJob.EvjInterval = WebConvert.ToInt32(Request.Form["txtEvjIntervalDaily"], 0);
                break;
            case 2:
                siteEventJob.EvjInterval = WebConvert.ToInt32(Request.Form["selEvjIntervalWeekly"], 0);
                break;
            case 3:
                siteEventJob.EvjInterval = WebConvert.ToInt32(Request.Form["txtEvjIntervalMonthly"], 0);
                break;
            default:
                siteEventJob.EvjInterval = WebConvert.ToInt32(Request.Form["txtEvjIntervalDaily"], 0);
                break;
        }
        siteEventJob.EvjName = WebConvert.Truncate(WebConvert.ToString(Request.Form["txtEvjName"],""), 50);
        siteEventJob.EvjEnabled = (Request.Form["selEvjEnabled"] == "1");
        siteEventJob.EvjBeginDate = WebConvert.ToDateTime(Request.Form["txtEvjBeginDate"], DateTime.Today);
        siteEventJob.EvjStopDate = WebConvert.ToDateTime(Request.Form["txtEvjStopDate"], DateTime.Today);
        siteEventJob.EvjDuration = WebConvert.ToInt32(Request.Form["txtEvjDuration"],0);
        siteEventJob.EvjDaysPublished = WebConvert.ToInt32(SiteSettings.GetValue("RecurringDaysPublished"), 0);
        siteEventJob.EvjSummary = WebConvert.Truncate(WebConvert.ToString(Request.Form["txtEvjSummary"], ""), 140);
        siteEventJob.EvjBody = WebConvert.ToString(Request.Form["txtEvjBody"], "");
        siteEventJob.SaveChanges();

        // sync to database
        db.SubmitChanges();

        // redirect to the dashboard
        Response.Redirect(Href("~/Business/RecurringEvents?msg=Modify"), false);
        return;
    }
}
@section head
{
	<script src="@Href( "~/Scripts/jquery.validate.min.js" )" type="text/javascript"></script>
	<script type="text/javascript">
	    $(document).ready(function () {
	        $("#frm").validate(
			{
			    messages:
				{
				    txtEvjName: { required: "required" },
				    selEjtID: { required: "required" },
				    txtEvjBeginDate: { required: "required" },
				    txtEvjStopDate: { required: "required" },
				    txtEvjDuration: { required: "required" },
				    selEttID: { required: "required" },
				    txtEvjSummary: { required: "required" },
	                txtEvjBody: { required: "required" }
	            }
			});
	    });
	</script>
}
	<!-- PAGE -->
	<div id="page">
        <!-- BREAD CRUMBS -->
        <div class="breadcrumbs Roles">
            <div class="breadcrumbGray"><a href="@Href( "~/Account/" )">Account Dashboard</a></div>
			<div class="breadcrumbSpacerGrayGray">&nbsp;</div>
            <div class="breadcrumbGray"><a href="@Href( "~/Business/Dashboard" )">Business Dashboard</a></div>
			<div class="breadcrumbSpacerGrayGray">&nbsp;</div>
            <div class="breadcrumbGray"><a href="@Href( "~/Business/RecurringEvents" )">Recurring</a></div>
			<div class="breadcrumbEndGray">&nbsp;</div>
        </div>
		<div id="fullSide">
			<h1>@HttpUtility.HtmlEncode(siteBusiness.BusName): @Html.Raw( Page.SitePage.Heading )</h1>
            @Html.Raw( Page.SitePage.Body )
            <!-- NOTIFICATION BOX -->
            @if(msg == "Purge")
            {
                <div class="NotificationBox Green">
                    <div class="NotificationMessage">All associated events have been removed.</div>
                    <div class="NotificationClose"></div>
                </div>
                <br />
            }

            <!-- DASHBOARD -->
            <form name="frm" id="frm" method="post" class="basicForm">
                <fieldset style="width:770px;">
                    <div>
                        <label for="txtEvjName">Recurring Event Name: *</label><br />
                        <input type="text" name="txtEvjName" id="txtEvjName" class="required" size="40" maxlength="50" style="width:350px;" value="@siteEventJob.EvjName" />
                    </div>
                    <br style="clear:left;" />
                    <br />
                    <div>
                        <label for="selEjtID">Period: *</label><br />
                        <select name="selEjtID" id="selEjtID" class="required" style="width:150px;">
                            <option value="">Select...</option>
                            @foreach( TblEventJobTypes row in rsEjt )
                            {
                                <option value="@row.EjtID" @( (row.EjtID == siteEventJob.EjtID ) ? " selected" : "" )>@(row.EjtName)</option>
                            }
                        </select>
                    </div>
                    <div style="margin-left:20px;">
                        <label for="txtEvjIntervalDaily">Every N Days (Daily):</label><br />
                        <input type="text" name="txtEvjIntervalDaily" id="txtEvjIntervalDaily" size="5" maxlength="5" style="width:100px;" value="@siteEventJob.EvjInterval" />
                    </div>
                    <div>
                        <label for="selEvjIntervalWeekly">Day of Week (Weekly):</label><br />
                        <select name="selEvjIntervalWeekly" id="selEvjIntervalWeekly" style="width:150px;">
                            @for (int i=0; i < 7; i++ )
                            {
                                <option value="@i" @( (i == siteEventJob.EvjInterval) ? " selected" : "" )>@((DayOfWeek)i)</option>
                            }
                        </select>
                    </div>
                    <div style="margin-left:20px;">
                        <label for="txtEvjIntervalMonthly">Day of Month (Monthly):</label><br />
                        <input type="text" name="txtEvjIntervalMonthly" id="txtEvjIntervalMonthly" size="5" maxlength="5" style="width:100px;" value="@siteEventJob.EvjInterval" />
                    </div>
                    <br style="clear:left;" />
                    <br />
                    <div>
                        <label for="txtEvjBeginDate">Date Range for Valid Events: *</label><br />
                        <input type="text" name="txtEvjBeginDate" id="txtEvjBeginDate" class="required" size="10" maxlength="10" style="width:150px;" value="@siteEventJob.EvjBeginDate.ToShortDateString()" />
                        to 
                        <input type="text" name="txtEvjStopDate" id="txtEvjStopDate" class="required" size="10" maxlength="10" style="width:150px;" value="@siteEventJob.EvjStopDate.ToShortDateString()" />
                    </div>
                    <div style="margin-left:50px;">
                        <label for="selEvjEnabled">Active: *</label><br />
                        <select name="selEvjEnabled" id="selEvjEnabled" class="required" style="width:150px;">
                            <option value="0">No</option>
                            <option value="1" @((siteEventJob.EvjEnabled) ? " selected" : "")>Yes</option>
                        </select>
                    </div>
                    <br style="clear:left;" />
                    <br />
                    <div>
                        <label for="txtEvjDuration">Duration (Days): *</label><br />
                        <input type="text" name="txtEvjDuration" id="txtEvjDuration" class="required" size="5" maxlength="5" style="width:100px;" value="@siteEventJob.EvjDuration" />
                    </div>
                    <div style="margin-left:20px;">
                        <label for="selEttID">Type: *</label><br />
                        <select name="selEttID" id="selEttID" class="required" style="width:150px;">
                            <option value="">Select...</option>
                            @foreach( TblEventTypes row in rsEtt )
                            {
                                <option value="@row.EttID" @( (row.EttID == siteEventJob.EttID ) ? " selected" : "" )>@(row.EttName)</option>
                            }
                        </select>
                    </div>
                    <br style="clear:left;" />
                    <br />
                    <div>
                        <label for="txtEvjSummary">Event Summary: *</label><br />
                        <input type="text" name="txtEvjSummary" id="txtEvjSummary" class="required" size="80" maxlength="140" style="width:750px;" value="@siteEventJob.EvjSummary" />
                    </div>
                    <br style="clear:left;" />
                    <br />
                    <div>
                        <label for="txtEvjBody">Event Body: *</label><br />
                        <textarea name="txtEvjBody" id="txtEvtBody" class="required" rows="10" cols="80" style="width:750px;">@siteEventJob.EvjBody</textarea>
                    </div>
                    <br style="clear:left;" />
                    <br />
                    <div style="float:none; margin-right:0px;">
                        <div class="orangeButtonRight">
                            <input type="submit" name="_btnSubmit" value="Update" class="button" />
                        </div>
                        <div class="orangeButtonRight">
                            <input type="button" name="_btnPurge" value="Purge" class="button" onclick="javascript: if( confirm('Are you sure you want to remove existing events for this definition?') ){ window.location = '/Business/EventJobsPurge/@evjID'; return true; }else{ return false; };" />
                        </div>
                        <div class="orangeButtonRight">
                            <input type="button" name="_btnDelete" value="Delete" class="button" onclick="javascript: if( confirm('Are you sure you want to delete this recurring event?') ){ window.location = '/Business/EventJobsDelete/@evjID'; return true; }else{ return false; };" />
                        </div>
                        <div class="orangeButtonRight">
                            <input type="button" name="_btnCancel" value="Cancel" class="button" onclick="javascript: window.location = '/Business/RecurringEvents';" />
                        </div>
                    </div>
                    <legend></legend>
                </fieldset>
            </form>
		</div>
		<br style="clear:left;" />
	</div>